import{colors as b,fs as _,path as U}from"@vuepress/utils";import{isLinkHttp as P,removeEndingSlash as j,removeLeadingSlash as D,isArray as F,isPlainObject as k,isFunction as m}from"@vuepress/shared";import{Logger as G,encodeXMLContent as C,encodeCDATA as H,deepAssign as K,stripTags as I,isUrl as $,getPageText as W,getAuthor as N,getCategory as q,getPageExcerpt as B,isAbsoluteUrl as A}from"vuepress-shared/node";import{js2xml as R}from"xml-js";const E="vuepress-plugin-feed2",O=new G(E),M=(i,t)=>!i||!(i instanceof Date)?1:!t||!(t instanceof Date)?-1:t.getTime()-i.getTime(),f=(i,t="",e="")=>`${P(i)?j(i):`https://${j(i)}`}${t}${D(e)}`,X=(i="")=>`image/${i==="jpg"?"jpeg":i==="svg"?"svg+xml":i==="jpeg"||i==="png"||i==="bmp"||i==="gif"||i==="webp"?i:""}`,w=i=>Object.fromEntries(Object.entries(i).map(([t,e])=>t==="_attributes"&&e?[t,Object.fromEntries(Object.entries(e).map(([a,r])=>[a,r?C(r.toString()):void 0]))]:t==="_text"?[t,C(e.toString())]:t==="_cdata"?[t,H(e)]:F(e)?[t,e.map(a=>w(a))]:k(e)?[t,w(e)]:[t,C(String(e))])),z=(i,t,e="",a="")=>{t in i&&(O.error(`"${b.magenta(t)}" is ${b.red("removed")}${a?`, please use ${b.magenta(a)} instead.`:" and no longer supported"}${e?`
${e}`:""}`),a||delete i[t])},Q=i=>{var t,e,a,r,n,s,o,u,l,p,d,c;i.atom=((e=(t=i.output)==null?void 0:t.atom)==null?void 0:e.enable)??!0,i.json=((r=(a=i.output)==null?void 0:a.json)==null?void 0:r.enable)??!0,i.rss=((s=(n=i.output)==null?void 0:n.rss)==null?void 0:s.enable)??!0,i.atomOutputFilename=((u=(o=i.output)==null?void 0:o.atom)==null?void 0:u.path)??"atom.xml",i.jsonOutputFilename=((p=(l=i.output)==null?void 0:l.json)==null?void 0:p.path)??"feed.json",i.jsonOutputFilename=((c=(d=i.output)==null?void 0:d.rss)==null?void 0:c.path)??"rss.xml",z(i,"output")},V=i=>i.hostname?(i.hostname=P(i.hostname)?j(i.hostname):`https://${j(i.hostname)}`,!0):!1,Y=i=>i.locales&&Object.entries(i.locales).some(([,{atom:t,json:e,rss:a}])=>t||e||a)||Boolean(i.atom||i.json||i.rss),Z=({siteData:i},t)=>Object.fromEntries(Object.keys({"/":{},...i.locales}).map(e=>{var a;return[e,{filter:({frontmatter:r,filePathRelative:n})=>!(r.home||!n||r.article===!1||r.feed===!1),sorter:(r,n)=>{var s,o,u,l;return M((s=r.data.git)!=null&&s.createdTime?new Date((o=r.data.git)==null?void 0:o.createdTime):r.frontmatter.date,(u=n.data.git)!=null&&u.createdTime?new Date((l=n.data.git)==null?void 0:l.createdTime):n.frontmatter.date)},...t,...(a=t.locales)==null?void 0:a[e],hostname:t.hostname}]})),tt=(i,t,e="")=>{var a,r,n,s,o,u,l;const{base:p}=i.options,{title:d,description:c,lang:g,locales:h}=i.siteData,{hostname:v,icon:y,image:L}=t,x=(r=(a=t.channel)==null?void 0:a.author)==null?void 0:r.name,J={title:((n=h[e])==null?void 0:n.title)||d||((s=h["/"])==null?void 0:s.title)||"",link:f(v,p,e),description:((o=h[e])==null?void 0:o.description)||c||((u=h["/"])==null?void 0:u.description)||"",language:((l=h[e])==null?void 0:l.lang)||g,copyright:x?`Copyright by ${x}`:"",pubDate:new Date,lastUpdated:new Date,...y?{icon:y}:{},...L?{image:L}:{},...x?{author:{name:x}}:{}};return K(J,t.channel||{})},S=(i,t="/")=>({atomOutputFilename:`${D(t)}${i.atomOutputFilename||"atom.xml"}`,jsonOutputFilename:`${D(t)}${i.jsonOutputFilename||"feed.json"}`,rssOutputFilename:`${D(t)}${i.rssOutputFilename||"rss.xml"}`}),et=({options:{base:i}},t)=>{const{hostname:e}=t,{atomOutputFilename:a,jsonOutputFilename:r,rssOutputFilename:n}=S(t);return{atom:f(e,i,a),json:f(e,i,r),rss:f(e,i,n)}},it=(i,t)=>{const{base:e}=i.options,{siteData:a}=i,r=Object.keys(t);if(r.length===1){const{atomOutputFilename:n,jsonOutputFilename:s,rssOutputFilename:o}=S(t["/"]),{atom:u,json:l,rss:p,hostname:d}=t["/"],c=(g,h,v)=>{var y;return["link",{rel:"alternate",type:v,href:f(d,e,h),title:`${a.title||((y=a.locales["/"])==null?void 0:y.title)||""} ${g} Feed`}]};a.head||(a.head=[]),u&&a.head.push(c("Atom",n,"application/atom+xml")),l&&a.head.push(c("JSON",s,"application/json")),p&&a.head.push(c("RSS",o,"application/rss+xml"))}else i.pages.forEach(n=>{const{pathLocale:s}=n,o=t[s];if(r.includes(s)){const{atomOutputFilename:u,jsonOutputFilename:l,rssOutputFilename:p}=S(o,s),d=(c,g,h)=>{var v,y;return["link",{rel:"alternate",type:h,href:f(o.hostname,e,g),title:`${((v=a.locales[s])==null?void 0:v.title)||a.title||((y=a.locales["/"])==null?void 0:y.title)||""} ${c} Feed`}]};n.frontmatter.head||(n.frontmatter.head=[]),o.atom&&n.frontmatter.head.push(d("Atom",u,"application/atom+xml")),o.json&&n.frontmatter.head.push(d("JSON",l,"application/json")),o.rss&&n.frontmatter.head.push(d("RSS",p,"application/rss+xml"))}})},T=i=>{const{name:t="Unknown",email:e,url:a}=i;return{name:t,...e?{email:e}:{},...a?{uri:a}:{}}},at=i=>{const{name:t,scheme:e=""}=i;return{_attributes:{term:t,scheme:e}}},nt=i=>{const{channel:t,links:e}=i.options,a={_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}},feed:{_attributes:{xmlns:"http://www.w3.org/2005/Atom",...t.language?{"xml:lang":t.language}:{}},id:t.link,title:t.title,...t.description?{subtitle:t.description}:{},...t.author?{author:T(t.author)}:{},updated:t.lastUpdated?t.lastUpdated.toISOString():new Date().toISOString(),generator:E,link:[{_attributes:{rel:"self",href:e.atom}}]}};return t.link&&a.feed.link.push({_attributes:{rel:"alternate",href:t.link}}),t.hub&&a.feed.link.push({_attributes:{rel:"hub",href:t.hub}}),t.image&&(a.feed.logo=t.image),t.icon&&(a.feed.icon=t.icon),t.copyright&&(a.feed.rights=t.copyright),a.feed.category=Array.from(i.categories).map(r=>({_attributes:{term:r}})),a.feed.contributor=Array.from(i.contributors).filter(r=>r.name).map(r=>T(r)),a.feed.entry=i.items.map(r=>{const n={title:{_attributes:{type:"html"},_text:r.title},id:r.guid||r.link,link:{_attributes:{href:r.link}},updated:r.lastUpdated.toISOString()};return r.description&&(n.summary=r.description.startsWith("html:")?{_attributes:{type:"html"},_cdata:r.description.substring(5)}:{_attributes:{type:"html"},_text:r.description}),r.content&&(n.content={_attributes:{type:"html"},_cdata:r.content}),r.author&&(n.author=r.author.filter(s=>s.name).map(s=>T(s))),r.category&&(n.category=r.category.map(s=>at(s))),r.contributor&&(n.contributor=r.contributor.map(s=>T(s))),r.pubDate&&(n.published=r.pubDate.toISOString()),r.copyright&&(n.rights=r.copyright),n}),R(w(a),{compact:!0,ignoreComment:!0,spaces:2})},rt=i=>({name:i.name,...i.url?{url:i.url}:{},...i.avatar?{avatar:i.avatar}:{}}),st=i=>{var t;const{channel:e,links:a}=i.options,r={version:"https://jsonfeed.org/version/1.1",title:e.title,home_page_url:e.link,feed_url:a.json};return e.description&&(r.description=e.description),e.image&&(r.icon=e.image),e.icon&&(r.favicon=e.icon),(t=e.author)!=null&&t.name&&(r.author={name:e.author.name,...e.author.url?{url:e.author.url}:{},...e.author.avatar?{avatar:e.author.avatar}:{}}),r.items=i.items.map(n=>{const s={title:n.title,url:n.link,id:n.guid||n.link,...n.description?{summary:n.description.startsWith("html:")?I(n.description.substring(5)):n.description}:{},content_html:n.content};return n.image&&(s.image=n.image),n.pubDate&&(s.date_published=n.pubDate.toISOString()),n.lastUpdated&&(s.date_modified=n.lastUpdated.toISOString()),F(n.author)&&(s.authors=n.author.filter(o=>o.name).map(o=>rt(o))),n.category&&(s.tags=n.category.filter(o=>o.name).map(o=>o.name)),s}),JSON.stringify(r,null,2)},ot=i=>{const{name:t,domain:e}=i;return{_text:t,...e?{_attributes:{domain:e}}:{}}},lt=i=>{const t=i.guid||i.link;return{...$(t)?{}:{_attributes:{isPermaLink:"false"}},_text:t}},ut=i=>({_attributes:{url:i.url,...i.length?{length:i.length}:{},...i.type?{type:i.type}:{}}}),pt=i=>{const{links:t,channel:e}=i.options;let a=!1;const r={_declaration:{_attributes:{version:"1.0",encoding:"utf-8"}},rss:{_attributes:{version:"2.0","xmlns:atom":"http://www.w3.org/2005/Atom"},channel:{"atom:link":{_attributes:{href:t.rss,rel:"self",type:"application/rss+xml"}},title:{_text:e.title},link:{_text:e.link},description:{_text:e.description},language:{_text:e.language},pubDate:{_text:e.pubDate?e.pubDate.toUTCString():new Date().toUTCString()},lastBuildDate:{_text:e.lastUpdated?e.lastUpdated.toUTCString():new Date().toUTCString()},generator:{_text:E},docs:{_text:"https://validator.w3.org/feed/docs/rss2.html"}}}};return e.copyright&&(r.rss.channel.copyright={_text:e.copyright}),e.ttl&&(r.rss.channel.ttl={_text:e.ttl.toString()}),e.image&&(r.rss.channel.image={title:{_text:e.title},url:{_text:e.image},link:{_text:e.link}}),r.rss.channel.category=Array.from(i.categories).map(n=>({_text:n})),r.rss.channel.item=i.items.map(n=>{const s={title:{_text:n.title},link:{_text:n.link},guid:lt(n),source:{_attributes:{url:t.rss},_text:n.title}};if(n.description&&(s.description={_text:n.description.startsWith("html:")?I(n.description.substring(5)):n.description}),n.author){const o=n.author.find(u=>u.email&&u.name);o&&(s.author={_text:`${o.email} (${o.name})`})}return n.category&&(s.category=n.category.filter(o=>o.name).map(o=>ot(o))),n.comments&&(s.comments={_text:n.link}),n.pubDate&&(s.pubDate={_text:n.pubDate.toUTCString()}),n.content&&(a=!0,s["content:encoded"]={_cdata:n.content}),n.enclosure&&(s.enclosure=ut(n.enclosure)),s}),a&&(r.rss._attributes["xmlns:content"]="http://purl.org/rss/1.0/modules/content/",r.rss._attributes["xmlns:dc"]="http://purl.org/dc/elements/1.1/"),R(w(r),{compact:!0,ignoreComment:!0,spaces:2})};class ct{constructor(t){this.options=t,this.items=[],this.categories=new Set,this._contributorKeys=new Set,this.contributors=[],this.addItem=e=>{this.items.push(e)},this.addCategory=e=>{this.categories.add(e)},this.addContributor=e=>{const a=e.email||e.name;a&&!this._contributorKeys.has(a)&&(this._contributorKeys.add(a),this.contributors.push(e))},this.atom=()=>nt(this),this.rss=()=>pt(this),this.json=()=>st(this)}}class ht{constructor(t,e,a,r){this.app=t,this.options=e,this.page=a,this.feed=r,this.base=this.app.options.base,this.frontmatter=a.frontmatter,this.getter=e.getter||{},this.pageFeedOptions=this.frontmatter.feed||{}}get title(){return m(this.getter.title)?this.getter.title(this.page):this.pageFeedOptions.title||this.page.title}get link(){return m(this.getter.link)?this.getter.link(this.page):f(this.options.hostname,this.base,this.page.path)}get description(){if(m(this.getter.description))return this.getter.description(this.page);if(this.pageFeedOptions.description)return this.pageFeedOptions.description;if(this.frontmatter.description)return this.frontmatter.description;const t=W(this.page);return t.length>180?`${t.slice(0,177)}...`:t}get author(){var t,e;return m(this.getter.author)?this.getter.author(this.page):F(this.pageFeedOptions.author)?this.pageFeedOptions.author:k(this.pageFeedOptions.author)?[this.pageFeedOptions.author]:this.frontmatter.author===!1?[]:this.frontmatter.author?N(this.frontmatter.author):(t=this.options.channel)!=null&&t.author?N((e=this.options.channel)==null?void 0:e.author):[]}get category(){if(m(this.getter.category))return this.getter.category(this.page);if(F(this.pageFeedOptions.category))return this.pageFeedOptions.category;if(k(this.pageFeedOptions.category))return[this.pageFeedOptions.category];const{categories:t,category:e=t}=this.frontmatter;return q(e).map(a=>({name:a}))}get enclosure(){return m(this.getter.enclosure)?this.getter.enclosure(this.page):this.image?{url:this.image,type:X(this.image.split(".").pop())}:null}get guid(){return this.pageFeedOptions.guid||this.link}get pubDate(){if(m(this.getter.publishDate))return this.getter.publishDate(this.page);const{time:t,date:e=t}=this.page.frontmatter,{createdTime:a}=this.page.data.git||{};return e&&e instanceof Date?e:a?new Date(a):null}get lastUpdated(){if(m(this.getter.lastUpdateDate))return this.getter.lastUpdateDate(this.page);const{updatedTime:t}=this.page.data.git||{};return t?new Date(t):new Date}get content(){return m(this.getter.content)?this.getter.content(this.page):this.pageFeedOptions.content?this.pageFeedOptions.content:B(this.app,this.page,{excerptLength:1/0})}get image(){if(m(this.getter.image))return this.getter.image(this.page);const{banner:t,cover:e}=this.frontmatter;if(t){if(A(t))return f(this.options.hostname,this.app.options.base,t);if($(t))return t}if(e){if(A(e))return f(this.options.hostname,this.app.options.base,e);if($(e))return e}const a=/!\[.*?\]\((.*?)\)/iu.exec(this.page.content);if(a){if(A(a[1]))return f(this.options.hostname,this.app.options.base,a[1]);if($(a[1]))return a[1]}return null}get contributor(){return m(this.getter.contributor)?this.getter.contributor(this.page):F(this.pageFeedOptions.contributor)?this.pageFeedOptions.contributor:k(this.pageFeedOptions.contributor)?[this.pageFeedOptions.contributor]:this.author}get copyright(){if(m(this.getter.copyright))return this.getter.copyright(this.page);if(this.frontmatter.copyright)return this.frontmatter.copyright;const t=this.author[0];return t!=null&&t.name?`Copyright by ${t.name}`:null}getFeedItem(){const{author:t,category:e,content:a,contributor:r,copyright:n,description:s,enclosure:o,guid:u,image:l,lastUpdated:p,link:d,pubDate:c,title:g}=this;return!g&&!s?null:(e&&e.forEach(h=>this.feed.addCategory(h.name)),r&&r.forEach(h=>this.feed.addContributor(h)),{title:g,link:d,guid:u,lastUpdated:p,content:a,author:t,contributor:r,...s?{description:s}:{},...e?{category:e}:{},...o?{enclosure:o}:{},...c?{pubDate:c}:{},...l?{image:l}:{},...n?{copyright:n}:{}})}}class dt{constructor(t,e){this.app=t,this.options=e,this.feedMap=Object.fromEntries(Object.entries(e).map(([a,r])=>[a,new ct({channel:tt(t,r,a),links:et(t,r)})]))}addPages(t){const e=this.feedMap[t],a=this.options[t],{count:r=100,filter:n=({frontmatter:l,filePathRelative:p})=>!(l.home||!p||l.article===!1||l.feed===!1),sorter:s=(l,p)=>{var d,c,g,h;return M((d=l.data.git)!=null&&d.createdTime?new Date((c=l.data.git)==null?void 0:c.createdTime):l.frontmatter.date,(g=p.data.git)!=null&&g.createdTime?new Date((h=p.data.git)==null?void 0:h.createdTime):p.frontmatter.date)}}=a,o=this.app.pages.filter(l=>l.pathLocale===t).filter(n).sort(s).slice(0,r);let u=0;for(const l of o){const p=new ht(this.app,a,l,e).getFeedItem();p&&(e.addItem(p),u+=1)}O.succeed(`added ${b.cyan(`${u} page${u>1?"s":""}`)} as feed item${u>1?"s":""} in route ${b.cyan(t)}`)}async generateFeed(){const{dest:t}=this.app.dir;await Promise.all(Object.entries(this.options).map(async([e,a])=>{if(a.atom||a.json||a.rss){const r=this.feedMap[e],{atomOutputFilename:n,jsonOutputFilename:s,rssOutputFilename:o}=S(a,e);this.addPages(e),a.atom&&(await _.ensureDir(U.dirname(t(n))),await _.outputFile(t(n),r.atom()),O.succeed(`Atom feed file generated and saved to ${b.cyan(`/${n}`)}`)),a.json&&(await _.ensureDir(U.dirname(t(s))),await _.outputFile(t(s),r.json()),O.succeed(`JSON feed file generated and saved to ${b.cyan(`${s}`)}`)),a.rss&&(await _.ensureDir(U.dirname(t(o))),await _.outputFile(t(o),r.rss()),O.succeed(`RSS feed file generated and saved to ${b.cyan(`${o}`)}`))}}))}}const mt=(i,t=!1)=>e=>{t&&Q(i),e.env.isDebug&&O.info("Options:",i);const a={name:"vuepress-plugin-feed2"};if(!V(i))return O.error(`Option ${b.magenta("hostname")} is required!`),a;if(!Y(i))return O.info("No requested output, the plugin won’t start!"),a;const r=Z(e,i);return{...a,onPrepared:n=>it(n,r),onGenerated:async n=>{await new dt(n,r).generateFeed()}}};export{mt as feedPlugin};
//# sourceMappingURL=index.js.map
